# --- Identity ---
project: culi_16s
sampleset: loris
dataset:   culi
runs:
  - hdz1
  - hdz2
  - hdz3
  - hdz4
  - hdz5
  - hdz6
  - hdz7
  - hdz8
  - hdz9
  - hdz10
  - hdz11
  - hdz12
  - hdz13
  - hdz14
  - hdz15
  - hdz16
  - hdz17
  - hdz18
  - hdz19

# --- Root ---
out_root: "/mnt/nrdstor/richlab/shared/datasets/16s" # Root of all other directories for data

# --- Start point ---
run_glob: "*"      # limit to a glob, e.g. "2025-10-*"
run_regex: ""      # or a regex, e.g. "^2025-10-(01|03)_"

# --- Layout ---
layout: # You only need to begin by transferring pod5_dir, sample_sheet_dir, sample_sheet_name, and sample_routing. The pipeline will populate the rest.
  pod5_dir:           "{sampleset}/pod5" # This is the initial directory where you load the raw pod5 files from an ONT run
  sample_sheet_dir:   "{sampleset}/samples" # Make sure you start with one dorado-friendly samplesheet for each of the runs (see above) in this directory.
  sample_sheet_name:  "{run}_sample_sheet.csv" # You should add the dorado-friendly samplesheet for demultiplexing barcoded reads under this name.
  sample_routing:     "{sampleset}/samples/sample_to_dataset.tsv" # Create a manifest where one column has the sample id and the second column identify's that sample's dataset (see above)
  dataset_dir:        "{sampleset}/{dataset}"
  raw_dir:            "{sampleset}/{dataset}/raw"
  basecall_dir:       "{sampleset}/basecalled/{run}"
  demux_dir:          "{sampleset}/demuxed/{run}"
  summary_dir:        "{sampleset}/dorado_summaries/{run}"

# --- Containers ---
container_rev:
  cpu: 2025-10-11a
  gpu: 2025-10-03b
  nanoalign: 2025-10-05
  dorado: 2025-10-05
container_cpu:       "docker://aliciamrich/nanomb-cpu"
container_gpu:       "docker://aliciamrich/nanombgpu"
container_nanoalign: "docker://aliciamrich/nanoalign"
container_dorado:    "docker://nanoporetech/dorado:latest"

# --- References ---

itgdb:
  seq_fasta:  "/mnt/nrdstor/richlab/shared/databases/itgdb_16s/taxa_itgdb_seq.fasta"
  tax_tsv:    "/mnt/nrdstor/richlab/shared/databases/itgdb_16s/taxa_itgdb_taxa.txt"
  sintax_udb: "/mnt/nrdstor/richlab/shared/databases/itgdb_16s/taxa_itgdb.udb"
  index_name: "ITGDB_16S.mmi"

# --- Dorado & Medaka ---
barcode_kit: "SQK-16S114-24"
dorado_model_name: "dna_r10.4.1_e8.2_400bps_sup@v5.2.0"
dorado_models_dir: "/models"
dorado_extra: ""
medaka_model: "dna_r10.4.1_e8.2_400bps_sup@v5.2.0:consensus"

# --- Dorado Trimming ---
trim_emit_fastq: true
trim_minlen: 0
trim_skip_glob: ["*NTC*", "*unclassified*"]

# --- Fastcat Filtering ---
minlength: 1200
maxlength: 1700
min_qscore: 15

# --- ITGDB mapping branch ---
itgdb_minimap:
  preset: "map-ont"
  primary_only: true    # --secondary=no -N 1
  mapq_min: 10          # PAF col12 (plan to filter more in R if using a value </=10)
  aln_min_bp: 1000      # PAF col11 (aln block length)

# --- SPOA guards ---
spoa_max_reads: 400
spoa_min_reads: 5
spoa_extra: ""

# --- VSEARCH OTUs / mapping / taxonomy ---
otu_id_primary: 0.995
otu_id_legacy:  0.97
map_id: 0.95
collapse_id: 0.997
strand: both
sintax_cutoff: 0.5
min_unique_size: 3

# --- Resources (per-rule; partitions differ where needed) ---
resources:
  dorado_basecall: {threads: 8,  mem_mb: 3200,  runtime: 180,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1' --constraint='gpu_v100|gpu_t4'"}
  dorado_demux:    {threads: 8,  mem_mb: 3200,  runtime: 120,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1' --constraint='gpu_v100|gpu_t4'"}
  dorado_trim:     {threads: 8,  mem_mb: 3200,  runtime: 120,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1' --constraint='gpu_v100|gpu_t4'"}
  medaka_polish:   {threads: 8,  mem_mb: 3200,  runtime: 240,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1'"}

  fastcat_filter:        {threads: 4,  mem_mb: 8000,  runtime: 60,  partition: batch, account: richlab}
  nanoplot_qc:           {threads: 2,  mem_mb: 4000,  runtime: 30,  partition: batch, account: richlab}
  
  itgdb_index:           {threads: 4,  mem_mb: 8000,  runtime: 60,  partition: batch, account: richlab}
  itgdb_taxmap:          {threads: 1,  mem_mb: 2000,  runtime: 15,  partition: batch, account: richlab}
  itgdb_map_reads:       {threads: 16, mem_mb: 32000, runtime: 720, partition: batch, account: richlab}
  itgdb_species_tables:  {threads: 2,  mem_mb: 8000,  runtime: 30,  partition: batch, account: richlab}
  
  isonclust3:            {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  spoa_consensus:        {threads: 8,  mem_mb: 16000, runtime: 720, partition: batch, account: richlab}
  vsearch_pool_cluster:  {threads: 16, mem_mb: 32000, runtime: 300, partition: batch, account: richlab}
  map_all_reads:         {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  racon_round1:          {threads: 16, mem_mb: 96000, runtime: 720, partition: batch, account: richlab}
  map_r1:                {threads: 8,  mem_mb: 16000, runtime: 180, partition: batch, account: richlab}
  racon_round2:          {threads: 8,  mem_mb: 64000, runtime: 720, partition: batch, account: richlab}
  chimera_taxonomy:      {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  collapse_ultraclose:   {threads: 8,  mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  otu_alignment:         {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  iqtree3_tree:          {threads: 16, mem_mb: 64000, runtime: 720, partition: batch, account: richlab}
  otu_table_per_sample:  {threads: 16, mem_mb: 16000, runtime: 180, partition: batch, account: richlab}