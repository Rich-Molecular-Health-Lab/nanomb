# --- Identity ---
project: culi_16S
sampleset: loris
dataset:   culi
runs:
  - hdz1
  - hdz2
  - hdz3
  - hdz4
  - hdz5
  - hdz6
  - hdz7
  - hdz8
  - hdz9
  - hdz10
  - hdz11
  - hdz12
  - hdz13
  - hdz14
  - hdz15
  - hdz16
  - hdz17
  - hdz18
  - hdz19

# --- Root ---
out_root: "$WORK/datasets/16s"

# --- Start point ---
run_glob: "*"      # limit to a glob, e.g. "2025-10-*"
run_regex: ""      # or a regex, e.g. "^2025-10-(01|03)_"

# --- Layout ---
layout:
  dataset_dir:        "{sampleset}/{dataset}"
  raw_dir:            "{sampleset}/{dataset}/raw"
  pod5_dir:           "{sampleset}/pod5"
  basecall_dir:       "{sampleset}/basecalled/{run}"
  demux_dir:          "{sampleset}/demuxed/{run}"
  summary_dir:        "{sampleset}/dorado_summaries/{run}"
  sample_sheet_dir:   "{sampleset}/samples"
  sample_sheet_name:  "{run}_sample_sheet.csv"
  sample_routing:     "{sampleset}/samples/sample_to_dataset.tsv"

# --- Containers ---
container_rev:
  cpu: 2025-10-11a
  gpu: 2025-10-03b
  nanoalign: 2025-10-05
  dorado: 2025-10-05
container_cpu:       "/mnt/nrdstor/richlab/shared/containers/nanomb.sif"
container_gpu:       "/mnt/nrdstor/richlab/shared/containers/nanombgpu.sif"
container_nanoalign: "/mnt/nrdstor/richlab/shared/containers/nanoalign.sif"
container_dorado:    "/mnt/nrdstor/richlab/shared/containers/dorado.sif"

# --- References ---
itgdb_udb:   "/mnt/nrdstor/richlab/shared/databases/itgdb_16s/taxa_itgdb.udb"
silva_fasta: "/mnt/nrdstor/richlab/shared/databases/silva138/SILVA_138.2_SSURef_NR99_tax_silva.fasta"
silva_index_name: "SILVA_138.2_SSURef_NR99.mmi"

# --- Dorado & Medaka ---
dorado_model_name: "dna_r10.4.1_e8.2_400bps_sup@v5.2.0"
dorado_models_dir: "/models"
dorado_extra: ""
medaka_model: "dna_r10.4.1_e8.2_400bps_sup@v5.2.0:consensus"
barcode_kit: "SQK-16S114-24"

# --- Dorado Trimming ---
trim_emit_fastq: true
trim_minlen: 1000
trim_skip_glob: ["*NTC*", "*unclassified*"]

# --- Fastcat Filtering ---
minlength: 1200
maxlength: 1700
min_qscore: 15

# --- Silva mapping branch ---
silva_minimap:
  preset: "map-ont"
  primary_only: true    # --secondary=no -N 1
  mapq_min: 10          # PAF col12 (plan to filter more in R if using a value </=10)
  aln_min_bp: 1000      # PAF col11 (aln block length)

# --- SPOA guards ---
spoa_max_reads: 500
spoa_min_reads: 1
spoa_extra: ""

# --- VSEARCH OTUs / mapping / taxonomy ---
otu_id_primary: 0.995
otu_id_legacy:  0.97
map_id: 0.965
strand: both
sintax_cutoff: 0
min_unique_size: 1

# --- Resources (per-rule; partitions differ where needed) ---
resources:
  dorado_basecall:
    threads: 8
    mem_mb: 32000
    runtime: 180
    slurm_partition: gpu
    slurm_account: richlab
    slurm_gres: "gpu:1"        
    slurm_extra: "--constraint='gpu_v100&gpu_t4'"            

  dorado_demux:
    threads: 8
    mem_mb: 3200
    runtime: 120
    slurm_partition: gpu
    slurm_account: richlab
    slurm_gres: "gpu:1"        
    slurm_extra: "--constraint='gpu_v100&gpu_t4'"     
    
  dorado_trim:
    threads: 8
    mem_mb: 32000
    runtime: 120
    slurm_partition: gpu
    slurm_account: richlab
    slurm_gres: "gpu:1"        
    slurm_extra: "--constraint='gpu_v100&gpu_t4'"     

  medaka_polish:
    threads: 8
    mem_mb: 3200
    runtime: 240
    slurm_partition: gpu
    slurm_account: richlab
    slurm_gres: "gpu:1"        
    slurm_extra: "--constraint='gpu_v100&gpu_t4'"     

  fastcat_filter:        {threads: 4,  mem_mb: 8000,  runtime: 60,  partition: batch, account: richlab}
  nanoplot_qc:           {threads: 2,  mem_mb: 4000,  runtime: 30,  partition: batch, account: richlab}
  silva_index:           {threads: 4,  mem_mb: 8000,  runtime: 60,  partition: batch, account: richlab}
  silva_taxmap:          {threads: 1,  mem_mb: 2000,  runtime: 15,  partition: batch, account: richlab}
  silva_map_reads:       {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  silva_species_tables:  {threads: 2,  mem_mb: 8000,  runtime: 30,  partition: batch, account: richlab}
  isonclust3:            {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  spoa_consensus:        {threads: 8,  mem_mb: 16000, runtime: 240, partition: batch, account: richlab}
  vsearch_pool_cluster:  {threads: 16, mem_mb: 32000, runtime: 300, partition: batch, account: richlab}
  map_all_reads:         {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  racon_round1:          {threads: 16, mem_mb: 96000, runtime: 720, partition: batch, account: richlab}
  map_r1:                {threads: 8,  mem_mb: 16000, runtime: 180, partition: batch, account: richlab}
  racon_round2:          {threads: 8,  mem_mb: 64000, runtime: 720, partition: batch, account: richlab}
  chimera_taxonomy:      {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  otu_alignment:         {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  iqtree3_tree:          {threads: 16, mem_mb: 64000, runtime: 720, partition: batch, account: richlab}
  otu_table_per_sample:  {threads: 16, mem_mb: 16000, runtime: 180, partition: batch, account: richlab}