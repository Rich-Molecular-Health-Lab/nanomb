# --- Identity ---
project: culi_16s
sampleset: loris
dataset:   culi
runs:
  - hdz1
  - hdz2
  - hdz3
  - hdz4
  - hdz5
  - hdz6
  - hdz7
  - hdz8
  - hdz9
  - hdz10
  - hdz11
  - hdz12
  - hdz13
  - hdz14
  - hdz15
  - hdz16
  - hdz17
  - hdz18
  - hdz19

# --- Root ---
out_root: "/mnt/nrdstor/richlab/shared/datasets/16s" # Root of all other directories for data

# --- Start point ---
run_glob: "*"      # limit to a glob, e.g. "2025-10-*"
run_regex: ""      # or a regex, e.g. "^2025-10-(01|03)_"

# --- Name normalization ---
names:
  drop_after: "_"      # split on "_"
  keep_right: true     # keep the right side by default
  replace: []          # optional [ [pattern, replacement], ... ]
  strip_suffix: []     # optional ["_R1", ".fastq", ...]
  lower: false

# --- Layout ---
layout: # You only need to begin by transferring pod5_dir, sample_sheet_dir, sample_sheet_name, and sample_routing. The pipeline will populate the rest.
  pod5_dir:           "{sampleset}/pod5" # This is the initial directory where you load the raw pod5 files from an ONT run
  sample_sheet_dir:   "{sampleset}/samples" # Make sure you start with one dorado-friendly samplesheet for each of the runs (see above) in this directory.
  sample_sheet_name:  "{run}_sample_sheet.csv" # You should add the dorado-friendly samplesheet for demultiplexing barcoded reads under this name.
  sample_routing:     "{sampleset}/samples/sample_to_dataset.tsv" # Create a manifest where one column has the sample id and the second column identify's that sample's dataset (see above)
  dataset_dir:        "{sampleset}/{dataset}"
  raw_dir:            "{sampleset}/{dataset}/raw"
  basecall_dir:       "{sampleset}/basecalled/{run}"
  demux_dir:          "{sampleset}/demuxed/{run}"
  summary_dir:        "{sampleset}/dorado_summaries/{run}"

# --- Containers ---
container_rev:
  cpu: 2025-10-11a
  gpu: 2025-10-03b
  nanoalign: 2025-10-05
  dorado: 2025-10-05
  tree: 0.5
container_cpu:       "$PROJ_ROOT/containers/nanomb.sif"
container_gpu:       "$PROJ_ROOT/containers/nanombgpu.sif"
container_nanoalign: "$PROJ_ROOT/containers/nanoalign.sif"
container_dorado:    "$PROJ_ROOT/containers/dorado.sif"
container_tree:       "$PROJ_ROOT/containers/nanotree.sif"

# --- References ---
itgdb:
  seq_fasta:  "/mnt/nrdstor/richlab/shared/databases/itgdb_16s/taxa_itgdb_seq.fasta"
  tax_tsv:    "/mnt/nrdstor/richlab/shared/databases/itgdb_16s/taxa_itgdb_taxa.txt"
  sintax_udb: "/mnt/nrdstor/richlab/shared/databases/itgdb_16s/taxa_itgdb.udb"
  index_name: "ITGDB_16S.mmi"

# --- Dorado & Medaka ---
barcode_kit: "SQK-16S114-24"
dorado_model_name: "dna_r10.4.1_e8.2_400bps_sup@v5.2.0"
dorado_models_dir: "/models"
dorado_extra: ""
medaka_model: "dna_r10.4.1_e8.2_400bps_sup@v5.2.0:consensus"

# --- Dorado Trimming ---
trim_emit_fastq: true
trim_minlen: 0
trim_skip_glob: ["*NTC*", "*unclassified*"]

# --- Fastcat Filtering ---
minlength: 1200
maxlength: 1800
min_qscore: 14

# --- ITGDB mapping branch ---
itgdb_minimap:
  preset: "map-ont"
  primary_only: true   
  mapq_min: 5          # PAF col12 (plan to filter more in R if using a value </=10)
  aln_min_bp: 600      # PAF col11 (aln block length)
  details_dir: "itgdb/reads" 
unknowns:
  enable: true
  id: 0.90
  iddef: 1
  min_total_abund: 2
  subsample_n: 500000   # 0 = no subsampling

# --- Clustering ---
pooled:
  enable: true            # set to false to revert to per-sample
  concat_name: "all_samples_pooled.fastq"
  isonclust3_extra: ""

# --- SPOA guards ---
spoa_max_reads: 800
spoa_min_reads: 2
spoa_extra: ""

# --- VSEARCH OTUs / mapping / taxonomy ---
otu_id_primary: 0.995
otu_id_legacy:  0.97
map_id: 0.90
collapse_id: 0.997
strand: both
sintax_cutoff: 0.2
min_unique_size: 1
taxonomy_filter:
  drop_euk_chl_mito: true
  patterns: ["Eukaryota", "Chloroplast", "Mitochondria"]
otu_mapping:
  iddef: 1          # vsearch identity definition (0=global,1=local)
  qcov: 0.80        # minimum query coverage fraction
  tcov: 0.80        # minimum target coverage fraction
  qmask: "none"     # masking method for low-complexity regions
medaka_batch: 100
max_medaka_reads: 500000
epa_ng:
  mpi_ranks: 1      # set >1 to use MPI build
  extra: ""         # e.g., "--filter-acc-lwr 0.99" if desired

# --- Optional Ep2ME Labs wf-16s for cross-referencing ---
wf16s:
  enable: false                 
  repo: "epi2me-labs/wf-16s"              # nextflow pipeline repo
  profile: "singularity"                  # or "docker" if you run docker
  extra_args: "--minimap2_by_reference"   # anything else you want to pass
  out_dir: ""                             # default set in Snakefile → OUT+"/wf16s"
  work_dir: ""                            # default set in Snakefile → TMP+"/wf16s_work"
  rev: ""

# --- Resources (per-rule; partitions differ where needed) ---
resources:
  dorado_basecall: {threads: 8,  mem_mb: 3200 ,  runtime: 180,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1' --constraint='gpu_v100|gpu_t4'"}
  dorado_demux:    {threads: 8,  mem_mb: 3200 ,  runtime: 120,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1' --constraint='gpu_v100|gpu_t4'"}
  dorado_trim:     {threads: 8,  mem_mb: 3200 ,  runtime: 120,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1' --constraint='gpu_v100|gpu_t4'"}
  medaka_polish:   {threads: 8,  mem_mb: 32000,  runtime: 240,  slurm_partition: gpu, slurm_account: richlab, slurm_extra: "--gres='gpu:1'"}

  fastcat_filter:        {threads: 4,  mem_mb: 8000,  runtime: 60,  partition: batch, account: richlab}
  nanoplot_qc:           {threads: 2,  mem_mb: 4000,  runtime: 30,  partition: batch, account: richlab}

  stage_wf16s_input:     {threads: 1,  mem_mb: 2000,  runtime: 15,  partition: batch, account: richlab}
  wf16s_run:             {threads: 12, mem_mb: 64000, runtime: 720, partition: batch, account: richlab}

  itgdb_index:            {threads: 4,  mem_mb: 8000,  runtime: 60,  partition: batch, account: richlab}
  itgdb_taxmap:           {threads: 1,  mem_mb: 2000,  runtime: 15,  partition: batch, account: richlab}
  itgdb_map_reads:        {threads: 16, mem_mb: 32000, runtime: 720, partition: batch, account: richlab}
  itgdb_species_tables:   {threads: 2,  mem_mb: 8000,  runtime: 30,  partition: batch, account: richlab}
  
  unknown_extract_p_samp: {threads: 1 , mem_mb: 2000 , runtime: 60 , partition: batch, account: richlab}
  unknown_subsample:      {threads: 1 , mem_mb: 1000 , runtime: 30 , partition: batch, account: richlab}
  unknown_pool:           {threads: 1 , mem_mb: 1000 , runtime: 15 , partition: batch, account: richlab}
  unknown_cluster:        {threads: 8 , mem_mb: 16000, runtime: 240, partition: batch, account: richlab}
  unknown_tbl_per_samp:   {threads: 8 , mem_mb: 16000, runtime: 240, partition: batch, account: richlab}
  merge_known_unknown:    {threads: 1 , mem_mb: 2000 , runtime: 20 , partition: batch, account: richlab}
  otu_taxonomy_best:      {threads: 1 , mem_mb: 1000 , runtime: 20 , partition: batch, account: richlab}
  apply_taxonomy_filter:  {threads: 1 , mem_mb: 1000 , runtime: 20 , partition: batch, account: richlab}

  pooled_concat_reads:   {threads: 2 , mem_mb: 4000 , runtime: 60 , partition: batch, account: richlab}
  isonclust3_pooled:     {threads: 16, mem_mb: 64000, runtime: 240, partition: batch, account: richlab}
  isonclust3:            {threads: 16, mem_mb: 64000, runtime: 240, partition: batch, account: richlab}
  spoa_consensus_pooled: {threads: 8 , mem_mb: 32000, runtime: 720, partition: batch, account: richlab}
  spoa_consensus:        {threads: 8,  mem_mb: 32000, runtime: 720, partition: batch, account: richlab}

  align_unknowns_to_backbone: {threads: 8, mem_mb: 8000, runtime: 60, partition: batch, account: richlab}
  iqtree3_model_extract:  {threads: 1 , mem_mb: 1000 , runtime: 5  ,  partition: batch, account: richlab}
  epa_place_unknowns:     {threads: 16, mem_mb: 32000, runtime: 180, partition: batch, account: richlab}
  graft_unknowns_on_tree: {threads: 2 , mem_mb: 2000 , runtime: 15 , partition: batch, account: richlab}
  sync_exports_for_R:     {threads: 1 , mem_mb: 2000 , runtime: 10 , partition: batch, account: richlab}
  
  vsearch_pool_cluster:  {threads: 16, mem_mb: 32000, runtime: 300, partition: batch, account: richlab}
  uniqify_otu_centroids: {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  map_all_reads:         {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  racon_round1:          {threads: 16, mem_mb: 96000, runtime: 720, partition: batch, account: richlab}
  map_r1:                {threads: 8,  mem_mb: 24000, runtime: 180, partition: batch, account: richlab}
  racon_round2:          {threads: 16, mem_mb: 96000, runtime: 720, partition: batch, account: richlab}
  chimera_taxonomy:      {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  collapse_ultraclose:   {threads: 8,  mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  otu_alignment:         {threads: 16, mem_mb: 32000, runtime: 240, partition: batch, account: richlab}
  iqtree3_tree:          {threads: 16, mem_mb: 64000, runtime: 720, partition: batch, account: richlab}
  otu_table_per_sample:  {threads: 16, mem_mb: 16000, runtime: 180, partition: batch, account: richlab}